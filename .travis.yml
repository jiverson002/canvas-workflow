# Tell Travis the project language.
language: ruby

# Route to the container-based infrastructure for a faster build.
sudo: false

# Enable caching the bundle between builds.
cache: bundler

# Branch whitelist.
branches:
  only:
    - master

# The stages of testing, building, and deploying the Canvas Workflow gem/site.
jobs:
  include:
    - # run RSpec tests (always run to detect the introduction of bugs)
      stage: test and [deploy] gem
      script:
        - bundle exec rspec
      # deploy gem to rubygems.org (only run on tagged commits)
      deploy:
        provider: rubygems
        api_key: $RUBYGEMS_API_KEY
        on:
          tags: true
    - # push changes to canvas (FIXME only run when site changes)
      stage: push site changes
      script:
        - bundle exec canvas push
      if: branch = master
    - # build and deploy site (FIXME only run when site changes)
      stage: build and deploy site
      script:
        # build site
        - bundle exec canvas build --with-bundler ; EXITCODE=$? ; (exit $EXITCODE)
        # deploy site
        - test $EXITCODE -eq 0 && bundle exec canvas deploy
      if: branch = master
